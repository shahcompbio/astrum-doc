---
title: Mira - Loading Data
sidebar_label: Loading Data
---

## Overview

Using the loaders will populate Elasticsearch with:

- Cell type (plus probabilities) and UMAP dimension data for each cell
- Gene expression (normalized log counts) for each cell
- Analysis metadata (patient ID and sample IDs)
- Marker genes for that specific dashboard

## Input

Mira was built to support merged datasets generated by the [single cell RNA pipeline](https://github.com/nceglia/scrna-pipeline), as such patient and cohort level dashboards.

For each dashboard loaded into Mira, the following files must be kept in the same directory, labelled with its dashboard ID

- cells.tsv
- genes.tsv
- matrix.mtx
- sample_metadata.json
- marker_genes.json

### cells.tsv

Each row in this file represents one cell in the dashboard.

Required columns:

- cell_id
- sample_id
- cell_type
- x
- y

Additional columns are currently not supported.

### genes.tsv

Each row in this file represents one gene.

Required columns:

- genes

No additional supports are currently supported.

### matrix.mtx

Each row in this file represents the normalized gene expression of one gene for a particular cell.

The columns aren't named here, but we assume that this the column order:

- gene index
- cell index
- log count

We assume that the gene index corresponds to the row number in genes.tsv (as in gene index 1 corresponds to the 1st row in gene.tsv).

We also assume the cell index corresponds to the row number in cells.tsv. If this is not the case, then cell_idx should be present as a column in cells.tsv

No additional supports are currently supported.

### sample_metadata.json

An array of JSON objects that describes the samples that make up this merged dataset. Each JSON object represents one sample.

Each object requires:

- sample_id

The loader supports any number of additional metadata, but we currently actively support these:

- patient_id
- surgery
- site
- sort

### marker_genes.json

An array of JSON objects that describes the various cell types in the dashboard and the marker genes used to define each cell type. This is typically run with CellAssign.

Each object requires:

- cell_type
- genes (as an array of genes)

We calculate a count of each cell type contained in cells.tsv, but this assumes that the names are identical.

No additional columns are currently supported.

## System Requirements

- Python 3

## Setup Virtual Environment

Clone Mira's database loader repository:

```
git clone https://github.com/shahcompbio/es-loaders
```

Create and start a new python3 environment

```
python3 -m venv <!!! /path/to/new/virtual/environment>

source <!!! /path/to/new/virtual/environment>/bin/activate
```

Install dependencies

```
pip install -r mira-requirements.txt
```

## Loading Data

To load one analysis into an ElasticSearch instance at `localhost:9200`, you can run the following command

```
python mira_cli.py load-analysis --type <dashboard_type> --id <dashboard_id> <path/to/data/directory>
```

Additional (optional) options:

- `--host` : ElasticSearch host. Defaults to `localhost`
- `--port` : ElasticSearch port. Defaults to `9200`
- `--chunksize` : How many records (by million) to read matrix file by. Defaults to 1.

```
python mira_cli.py --host <ES_host> --port <ES_port> load-analysis --type <dashboard_type> --id <dashboard_id> --chunksize <int> <path/to/data/directory>
```

At the end, you should expect:

1. A new index called `dashboard_cells_<dashboard_id>`
2. Additonal records in `marker_genes` (equal to number of cell types specified in `marker_genes.json`)
3. One additional record in `dashboard_entry`

:::note
If this the first time data has been loaded into this ElasticSearch instance, you will also need to load the gene list. This will require that `genes.tsv` is located in the specified directory.

This only needs to be done ONCE.

```
python mira_cli.py --host <ES_host> --port <ES_port> load_genes <path/to/data/directory>
```

:::

## Deleting data

To delete data:

```
python mira_cli.py --host <ES_host> --port <ES_port> clean_analysis <dashboard_id>
```

If you're interested in reloading data, the loading function has a reload flag:

```
python mira_cli.py --host <ES_host> --port <ES_port> load-analysis --reload --type <dashboard_type> --id <dashboard_id> <path/to/data/directory>
```

## Loading SPECTRUM data

:::caution
SPECTRUM (MSK) specific
:::

Currently, scRNA analyses are run through Isabl. As such, we've written additional code to automatically pull metadata and data files from Isabl / Juno. There is a bulk loading method:

```
python mira_cli.py load-analyses --type <dashboard_type> --id <dashboard_id> <path/to/data/directory>
```

Options:

- `--host` : ElasticSearch host. Defaults to `localhost`
- `--port` : ElasticSearch port. Defaults to `9200`
- `--chunksize` : How many records (by million) to read matrix file by. Defaults to 1.
- `--download` : Whether to download the data (by dashboard_id) from Juno (matches to Isabl)
- `--load-new` : If ID is not specified, whether to look into Isabl and load all dashboards of the same type that have not been loaded into the ElasticSearch instance
- `--load-cohort` : If dashboard type is cohort, specify whether to load the entire cohort (`cohort`), the cell type subsetted cohort (`cell_type`), or both (`both`)
